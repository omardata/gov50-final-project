---
title: "Gov 50 Final Project"
author: "Omar Cano"
description: "My final project"
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include = FALSE}
library(tidyverse)
library(tidyverse)
library(dplyr)
##install.packages("lubridate")
##install.packages("countrycode")
library(lubridate)
library(countrycode)

##load("~/Desktop/GOV 50/Projects/Final/final_project/data/un_votes.RData")


```


```{r ideal_data_prep, include = FALSE }
ideal <-  read.csv("data/IdealpointestimatesAll_Jul2023.csv")

## Adding year from session 
ideal <- ideal|> mutate( country_cowc = countrycode(ccode, origin = 'cown' , destination = 'cowc'),
                         country_cown = ccode,
                         year_match = session + 1945)
## W/O USA
ideal_wo_us <- ideal|> 
  group_by(country_cown, year_match)|>
  select(ccode, session, IdealPointAll, Countryname, year_match, country_cown, country_cowc)|>
  filter(!country_cown == 2)

## US Values only
ideal_onlyus <- ideal|>
  filter(country_cown == 2)|>
  select(session, IdealPointAll)|>
  mutate(idealpoint_us = IdealPointAll)|>
  select(!IdealPointAll)

## ideal now has US value
ideal<- ideal|> 
  left_join(ideal_onlyus, by = join_by(session))

ideal <- ideal|> 
  mutate(distance = idealpoint_us - IdealPointAll)|>
  mutate(distance_abs = abs(distance))

##Familiarizing Self w data
###ideal|> ggplot(mapping = aes(x = distance_abs))+geom_histogram()
##ideal|> ggplot(mapping = aes(x = distance))+geom_histogram()

## New objects for joining to ideal values of ideal point from previous years
minus_one <- ideal|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session - 1)

minus_two <- ideal|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session - 2)
 
plus_one <- ideal|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session + 1 )

plus_two <- ideal|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session + 2)


## Adding new columns of sideal values of ideal point from previous years two years

ideal <- ideal|> left_join(plus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_one"))


ideal <- ideal|> left_join(plus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_two"))

## Ordering and new titles for columns 
ideal<- ideal|> 
  mutate(distance_two_before = distance_abs_plus_two,
         distance_one_before = distance_abs_plus_one,
         distance_duplicate = distance_abs)

## Mutating for difference 
ideal<- ideal|> 
  mutate(change_one_before = distance_one_before - distance_duplicate,
         change_two_before = distance_two_before - distance_duplicate)


```



```{r aid_data_prep, include = FALSE}
## This is the aggregated data, can choose to use thes disaggregated later, if time 
aid <- read.csv("data/AidDataCoreDonorRecipientYear_ResearchRelease_Level1_v3.0.csv")

## Got correct number of row? Yes. 

##gives data from 1973 to 2013 
aid_us <- aid|>
  filter(donor == "United States")

##Change from  recepient name to COW character country code, add COW numeric code for matching w Ideal point data
aid_us <- aid_us|> mutate( country = countrycode(recipient, origin = 'country.name', destination = 'cowc'))
aid_us <- aid_us|> mutate( country_cown = countrycode(country, origin = 'cowc', destination = 'cown'))

aid_us_test<- aid_us |> filter(is.na(country_cown))

## Aid US, changing date, PLUS on year. In order to use previous year's aid commitments to the vote year
aid_us <- aid_us |> mutate(year_match = year + 1)


```

```{r testing_name_conversion, include = FALSE}
## Testing Names, there are no names that are ambiguously coded for COW C that show up in the UN voting data anyway, so there are no errors for COW N either 
unique(aid_us_test$recipient)
unique_names <- unique(ideal$Countryname) ## Possible problem  using ideal
unique_names <- enframe(unique_names)
View(unique_names)
cart|> filter(Countryname == "Serbia")


```


```{r joining_aid_ideal}
##Checking that UN is unique? Good. 
aid_us|>
  count(country_cown, year_match) |>
  filter(n > 1)

## Remove data for country_cown is N/A
aid_us <-  aid_us|>filter(!is.na(country_cown))

## Check that ideal point is unique? Good.
ideal|>
  count(country_cown, year_match) |>
  filter(n > 1)

##Joined Aid and Ideal
ideal_aid <- ideal|> 
  left_join(aid_us, join_by(country_cown, year_match))

## adding column for zeros instead of NAs
ideal_aid<- ideal_aid |>
  mutate(committed = if_else( is.na(commitment_amount_usd_constant_sum), 0, commitment_amount_usd_constant_sum ))
         
## Adding millions
ideal_aid<- ideal_aid |>
  mutate(committed_millions = committed/ 1000000)

View(ideal_aid)

## Adding groups for aid determination
ideal_treat<- ideal_aid|> mutate(treatment_any =  if_else(committed_millions > 0, 1, 0),
                                 treat_some = if_else( (committed_millions > 0) & (committed_millions <= 1), 1, 0),
                                 treat_middle = if_else( (committed_millions > 1) & (committed_millions <= 100),1,0),
                                 treat_high = if_else(committed_millions > 100, 1, 0),
                                 treat_bil = if_else(committed_millions > 1000, 1, 0),
                                 treat_sig = if_else(committed_millions > 10, 1, 0)
                                )

## Sub-setting to the data that we will actually use,  
ideal_treat_fil<- ideal_treat |>filter(session == 29:69)

```



## 1 Introduction: introduce the research question and hypothesis and briefly describe why it is interesting (1-2 paragraphs)
This paper will explore the relationship between a country's foreign-policy preferences and the amount of aid that country receives from the United States. Ultimately the question that interests me is does US provision of aid make the recipients of aid more inclined to the support of the US-led liberal world order? 

The underlying foreign policy preferences of a state are a central concern in international relations literature-  “perhaps the most fundamental issue” in the discipline (Johnston 2005, 1040). It is of great interest to be able to predict which factors affect whether a state is likely to support one foreign policy over another. A state's preferences play a part in guiding how a state acts, but these preferences are not a "not directly observed and thus need to be inferred from observable behavior"(Dreher et al). Thus many turn to votes in the United Nations General Assembly as a place to observe state behavior and attempt to operationalize and quantify state preferences. UNGA votes are an attractive option primarily because "they are comparable and observable actions taken by many countries at set points in time"(Dreher et al). 

However, it is crucial to emphasize that there might be some important differences between a state's underlying preference and how a state chooses to vote in the UNGA. A  state's foreign policy preference might be just one among a number of factors that affect that state votes. For instance, while a country might vote the same way as the Unite States on all resolutions in the UNGA, other factors such as strategic calculation or coercion might be at play. That is to say, just because the voting patterns of a pair of countries align, it is not necessarily the case that that the preferences of these two countries aligns. For example, there is some evidence for US practice of using the IMF and World Bank to buy support from other member states for its position on votes in the United Nations General Council (reference Dreher and Strun 2012). While some anlaysis such as  (another is Dreher, Axel, P. Nunnenkamp, and R. Thiele. 2008 (‘‘Does US Aid Buy UN General Assembly Votes? A Disaggregated Analysis.’’ Public Choice 136 (1): 139-64.)) give a robust treatement of the quesiton regarding the effects of different types of aid, they are still interested in simply in the voting coincidence of the US and a recipient of its aid. However interesting this sort of analysis is, my paper aims to do something a bit different than a focus on vote-buying relationship between the the US and other countries but rather on the effect of US aid on underlying state-preference. 

My  research question is this: Do the state preferences of countries that receive US aid become more aligned with those of the US? My central hypothesis is that when the US committs to giving a country aid, it becomes more likely that the state preferences between these two countries align. A second hypothesis that I am interested in testing is whether or not the  recipients of greater levels of US aid are more likely to align, and align to a greater degree with the US than recipients of lower amounts of US aid. The null hypothesis is that variation in the foreign policy alignment between the the US and other countries is due to random chance and not to the amount of aid that a country receives from the US. 

WHY!!! Hyp? 
you need to present a plausible story why the hypothesis might be true. Often, this is in the form of a behaviorial or institutional explanation. As social scientists, we are not interested in idiosyncratic explanations; we want to understand systematic patterns and relationships!

Evidence for an increase in alignment between the US and another country would be to see a decrease in the distance between the foreign policy preference of these two countries. Thus evidence for my hypothesis would be to see that following the commitment of aid this distance would decrease, that is we would see a negative change after thes commitment of aid.  


## 2 Data Section ---------- Briefly describes the data source, describes how the key dependent and independent variables are measured (e.g., a survey, statistical model, or expert coding), and also produces a plot that summarizes the dependent variable) (2-3 paragraphs)

In order to analyze this effect I use two pretty cool data sets, one for the dependent variable and one for the independent variable.

My dependent variable, `change_one_before`, is calculated from estimated measures of state preference provided by Dreher et. all 2008. This numeric estimate of state preference that Dreher et al provide is the result of a statistical model  that uses, in part, Eric Voeten's data on member-state votes in the United Nations General Assembly. This numeric measure of state-preference is given at a state/session level, that is it provides a single measure of state preference for a given country, in a given year. This ideal point data is more than just measure of state voting coincidence with the US-- this data set is one of the things that makes this paper interesting. This ideal point estimate is a ultimately, a measure to "consistently capture the position of states vis-a`-vis a US-led liberal order."(pg 431). Dreher et al explicitly emphasize the suitability of their ideal point estimates for analyzing the influence of aid, thus this is an interesting project that is taking this cool data from a statistical model and using it to attempt to learn about the dynamic that unfolds with US aid. 

There are a two steps to calculating my dependent variable `change_one_before`. First, I had to calculate a measure of the alignment of state preference between a given country and the US for a given session.  The variable `distance_abs` is a measure of the alignment of a given country  with the US in a given session, arrived at by subtracting the value of the a given countries ideal-point estimate for a particular session from the USA's ideal-point estimate for that same session, and finally taking the absolute value. Second, I use this `distance_abs` variable to calculate a measure of how a  countries preference alignment with the US has changed from the past session to the current session. Thus, my dependent variable `change_distance_one`, for a given country in session n is calculated by subtracting the `distance_abs`of session n from the `distance_abs` value for that country in session n-1.

Data for my independent variable, `treatment_any` comes from  AidData’s Core Research Release Version 3.0. This variable is a binary variable that is calculated from AidCores aggregated data (but also, they provide disaggreated data that is coded much more detail) on the amount of bilateral aid that a country reports that they committed to giving another country. This includes aid that was reported from various sources and is given in constant ($USD for 2011) dollars, and in million to allow for time-series analysis. This raw data is reported under the variable `commitment_millions`. This data is also reported at a recipient-year level, meaning that it provides the amount that the United State's committed to a given state in a given year. I follow the practice of assuming that if a country didn't report aid to  a country in a given year then the commitment of aid for that year was in fact zero. I also take a commitment to providing aid as a sufficient variable for analysis though there might be some discrepancy for aid that actually is paid out and aid that is committed, and thus some room for further analysis of aid actually delivered as the treatment condition.= 

If we look at all the distribution of all `change_one_before` for all session, it appears that the variable follows a normally distribution, centered at about zero, with a standard deviation of `r change_one_sd`. 


```{r}
changes_dist <- ideal_treat|> 
  ggplot(mapping = aes( x = change_one_before))+
  geom_histogram()

change_one_sd <- sd(ideal_treat$change_one_before, na.rm = TRUE)

summary(ideal_treat$change_one_before)

  
```

My research design employs a differences-in-differences approach. I treat the the commitment of aid as the treatment condition and want to investigate its effect on the alignment of state preferences. My independent variable is `treatment_any` and my depended varibale is `change_one_before`. Both of my variables are determined for country-session pairs.

My independent variable is `treatment_any` is a binary variable describing whether or not a country was the recipient of any non-zero amount of US foreign aid in the preceedidng year. The control is no aid commitment reported as `0`, and receiving aid is the treatment reported as `1`.  Said differently, I lag the treatment variable to make it so that for a given session n, a  country is counted as being in the control group if and only if it received a commitment for aid in the the year before that session. Lagging the time of the of the commitment by one year is to provide the opportunity to observe an effect of treatment, whose effect's we might miss if we weren't to lag treatment. 

My dependent variable is`change_one_before` is a numeric variable describing the change in foreign policy alignment with the United States from the previous year to the current year. For a given country in session n we can calculate the difference in how that countries alignment with the United States has changed from the previous session, n-1. There is room for some confusion that should be preempted, an increase in alignment would be indicated by a negative value for `change_one_before`, because this would indicate a decrease in the distance between the foreign policy preferences of the US and a given country. 

To calculate the difference in differences we can then first take the average change among all countries in the control group and subtract it from the average change of all countries in the treatment group. This gives us an estimated average treatment effect. We can also run a regression of the values 

I work under the assumption that in a given session all countries will experience, on average parallel trends through time. Thus, if we observe a decrease in the distance from the USA for countries that are in the treatment group that is relatively higher than the decrease that we observe for those in the treatment, this would be evidence for my hypothesis. That is a statistically significant negative ATE would be evidence for my hypothesis. 

## Results--------- plot of main analysis + regression output + 2-3 paragraphs of description and interpretation of the plots and regression (including interpreting the main coefficient of interest and describing if it is statistically significant and if we should interpret it causally). This section could be longer if you choose to include additional analyses. (8pts)
In summary my findings through the proposed difference in difference approach are rather mixed and inconclusive. While the regresssion that I arrive it does predict that on average the commitment of any amount of bilateral aid from the US to another country is correlated with a foreign-policy preference convergence between the US and that country, this prediction is not statistically significant and care should be taken to not construe even a statistically signifcant result as casual. 

My first and primary analysis used a difference in differences approach for the average change from the previous session to the current session, and finds that a country in the treatment group is on average predicted to have a decrease in their distance from the United States. The regression analysis  on the treatment as a categorical predictor yields two coefficients. One is an intercept which represents the models prediction for the baseline group, that is the control group. The value of the intercept is `r intercept` indicating that on average countries in the control were slighly more likely to increase their distancce from the US. However it is imporant to keep in mind that For countries in the control this model is rather uninformative, this intercept coeficient is not statistically signifcant, and in fact is highly arbitrary. For countries in the control this model is rather uninformative. 

For for countries in the treatment group the model provides a more clear prediction. The main coefficient of interest is equivalent to the average treatment effect reported in tables ___. This coefficient is `r main_coef` negative indicating that for a country that has received any amount of aid we should expect to see the distance between that country and the United States decrase by More specifically we should expect to see a decrease in the distance of approximately `r -1*main_coef`. However, with a p-value of `r main_coef_p`, this coeficient is not statistically significant. Thus wiht this approach I cannot reject the null hypothesis of any observed difference being due to pure chance. However, in the following section I perform antother test that __. 

### Main Analysis
```{r}

## Creating table for ATE in a given session
ate_table <-ideal_treat|> 
  group_by(session, treatment_any)|>
  summarize(mean_change_one = mean(change_one_before, na.rm = TRUE))|>
  pivot_wider(names_from = treatment_any,
              values_from = mean_change_one)|>
  mutate(session_ate = `1` - `0`)|>
  filter(!is.na(session_ate))

ate_table_names<- ate_table[, c(1, 3, 2, 4)]
colnames(ate_table_names) <- c("Session", "Treatment", "Control", "Sesssion ATE")

## Gives table for ATE in a given session 
knitr::kable(ate_table_names)

## Making ATE table longer, for visualization
ate_table_longer<- ate_table|> 
  select(!session_ate)|>
  pivot_longer(
    cols = `0`:`1`,
    names_to = "treatment",
    values_to = "change_one_before"
  )|>
  mutate(treatment = as.numeric(treatment))

## This is a geom_point showing treatment and control means across all sessions that we can compare with this data
ate_table_longer|> 
  ggplot(mapping = aes(x = session,
                       y = change_one_before))+
  geom_point(mapping = aes(color = treatment))

##Regression Plot for the Session ATEs.
ate_table_longer_num <-ate_table_longer|> 
  mutate(treatment = as.numeric(treatment))

ate_table_longer_num|> 
  ggplot(mapping = aes(x = treatment,
                       y = change_one_before))+
  geom_point()+
  geom_smooth(method = "lm", 
              formula = y ~ x,
              se = FALSE
              )

## Regression 
fit_ate_table_any<- lm(change_one_before ~ treatment, data = ate_table_longer)
sum_fit_ate <- summary(fit_ate_table_any)$coefficients

intercept<- sum_fit_ate[1,1]
int_p<- sum_fit_ate[1,4]

main_coef<- sum_fit_ate[2,1]
main_ceof_p<- sum_fit_ate[2,4]

  
  
  

```


##Secondary Analysis, comparing data as a pooled across time to estimate average treatement effect average, but not across sessions
```{r}
##Distribution Chart for all observed country changes in the period of interest
ideal_treat_fil|> 
  mutate(treatment_any = as.factor(treatment_any))|>
  ggplot(mapping = aes(x = change_one_before,
                        fill = treatment_any,
                        color =  treatment_any))+
  geom_histogram()

## Using multiple variables, multiple levels of aid
fit_treat_all <- lm (change_one_before ~ treatment_any, data = ideal_treat_fil)
summary(fit_treat_all)

fit_treat_all_multi <- lm (change_one_before ~ treatment_any + treat_some + treat_middle + treat_high, data = ideal_treat_fil)
summary(fit_treat_all_multi)

```



## Conclusion a brief (one paragraph) concluding section that summarizes your results, assesses the extent to which you find support for your hypothesis, describes limitations of your analysis and threats to inference, and states how your analysis could be improved (e.g., improved data that would be useful to collect).1 paragraph (i) summarizing results and assessing the extent to which you find support for your hypothesis; (ii) describing limitations of the analysis and threats to inference (missing data, confounding, etc), and stating how you could improve your analysis if you had more time/money. (2pts)

In conclusion, this paper was an exploration of the data that hoped to illuminate the relationship between foreign-policy preferences and US provision of foreign aid. A difference in differences appproach treated the the commitment to providing any amount of aid as a treatment condition and analyzed the effect of this condition on the foreign policy alignment of a coutry with the US. My finding were ultimately mixed and inconclusive. While the regresssion that I arrive it does predict that on average the commitment of any amount of bilateral aid from the US to another country is correlated with a foreign-policy preference convergence between the US and that country, this prediction is not statistically significant and care should be taken to not construe even a statistically signifcant result as casual.A second analysis that pooled all avaible data and treated it as a cross-section analysis of the effect of aid, provided simiarly suggestive but inconclusive results that were no statistically significant. Thus, evidence for my hyppothesis is weak, and I can not rule with any interesting level of probability that the result I obesrved are due to random chance. 

While this paper was unable to demonstrate statistically significant evidence for the hypothesis it shows some promise as a project for further exploration. There are ample opportunities to improve on this anlysis. Among them are threats to the inference, namely confounding varibales that are not being controlled for in any of the analysis that I performed. Anohter is that while the data set that was used for my independent variable is detailed, it is still the limiting factor in the range of sessions that I was able to analyze. This missing data kept me from including in my analysis the exiting state-preference data on the first 28 sessions of the United Nations. Similarly one important thing to note about the use of my dependent variable is that for all the virtures of the ideal-point estimates that Dreher et al provide, when used as I have used them, to compare the distance or alignment of two countries, their estimates give no directional relationship. That is to say,  we cannot conclude with certainty, even from a statistically significant result, that the provision of US aid is causing the recipient of aid  to move closer to the foreign policy preference of the US. The data and approach that I used for my dependent variable is mute on the point of just how two countries arrived at the new distance of their preference - it does not rule out any combination of both donor and recepeint chaning their preferences.If I were to have more time to perform this analysis, the most fruitful addition would be to identify and include data on possible confounders and to include this in a multi-variable regression. It is possible that the inclusion of such variables in my regression anlysis might just have produce a substantively similar difference in means as I found in this paper, but one that would display a statistical significance. 



















































## Scrap Writing
I want to explore the extent to which there is state agreement on certain votes? 
The effect of something on voting coincidence in a particular time period and in a particular topic? 

The effect of political turn-over in the UNGA voting coincidence?
The role of leaders?
The role of some country-level feature?
 
 
Do small states agree more, do large states disagree more?
Democratic or Republican presidents at the UN?
Are there any statistical differences?



Which subset of states? 
Which votes, how to measure voting coincidence. Mutate,and create new variable that states coindidence or no coindidence. There are 

Domestic Turn-over, or... international factors.. 

 
What are valid and easy paper topics?
I just need either an easy GOV 50 paper, or an easy overlap between the GOV 50 paper and the UN paper. 

Do work on the UN paper first. Maybe whether or not there is an overlap. 


Can also just do a single-time analysis. 
Need something to test about the countries. '

```{r}
##Counting Number of Votes Total by Party
cart |> group_by(party)|>
  summarize(total = length(unique(rcid)))

##Mean Coincidence by Party
cart|> group_by(party)|>
  summarize(mean_coin = mean(weight_coin_us, na.rm = TRUE))

##Mean Coincidence per President
cart|> group_by(president)|>
summarize(mean_coin = mean(weight_coin_us, na.rm = TRUE))

##Maybe remove the israel votes? Maybe look at 
##Maybe look at who votes in line with the US most often?

cart|> group_by(Country, party)|>
  summarize(mean_coin_country = mean(weight_coin_us, na.rm = TRUE))|>
  pivot_wider(names_from = party, 
              values_from = mean_coin_country)|>
  mutate(ate = `Democrat` - `Republican`)|>
  ggplot(mapping = aes( y = ate))+
  geom_histogram()
```

```{r}
# Testing trump 
votes_trump<- completeVotes|>
  filter(year >= 2017)|>
  group_by(rcid)|> 
  summarize(mean = mean(vote ==1) )

votes_trump

View(completeVotes)

unique(completeVotes$year)
votes_trump|> summarize(mean = mean(mean))


votes_obama <- completeVotes|>
  filter(year < 2017 & year>2008)|>
  group_by(rcid)|> 
  summarize(mean = mean(vote ==1) )
votes_obama|> summarize (mean = mean(mean))


  group_by(rcid)|>
  summarize(mean_yes = mean(vote == 1))|>
  ggplot( mapping = aes( x =mean_yes))+
  geom_histogram(binwidth = .05)

## From LEAD data
lead_trump<- lead |> filter(year >= 2019)
lead
unique(lead_post1975$idacr)

```



```{r}
## Editing Dates on President's to Match UNGA Votes Format 
presidents <- presidents |> 
  mutate(left_office = as.Date(Left.office, format = "%d/%m/%Y"),
         took_office = as.Date(Took.office, format = "%d/%m/%Y"))

## Vote data to correct date format
completeVotes2 <- completeVotes|> mutate(
  date = as.Date(date, format = "%Y-%m-%d"))

View(completeVotes2)

##Subset UN Data, want only carter to Obama Votes
carter_obama <- completeVotes2|>
  filter( date > "1977-01-20" & date < "2017-01-20") ## needed to use just greater or lesser than

View(carter_obama)

##creating vector of democrat presidents 
democratic_indiators <- c("1", "4", "6")

##Assigning Presidency, Rep or Dem, and also president identifier 1 for carter, 2 for Reagan etc 
cart <- carter_obama|>
    mutate(pres_indicator = case_when( (date > "1977-01-20" & date < "1981-01-20") ~ "1",
                                       (date > "1981-01-20" & date < "1989-01-20") ~ "2",
                                       (date > "1989-01-20" & date < "1993-01-20") ~ "3",
                                       (date > "1993-01-20" & date < "2001-01-20") ~ "4",
                                       (date > "2001-01-20" & date < "2009-01-20") ~ "5",
                                       (date > "2009-01-20" & date < "2017-01-20") ~ "6")
           )|>
  mutate(democrat = if_else(pres_indicator %in% democratic_indiators, "1", "0"))|>
  mutate(party = if_else(democrat == 1, "Democrat", "Republican"))|>
  mutate(president = case_when(pres_indicator == 1 ~ "Jimmy Carter",
                               pres_indicator == 2 ~ "Ronald Reagan",
                               pres_indicator == 3 ~ "George H. W. Bush",
                               pres_indicator == 4 ~ "Bill Clinton",
                               pres_indicator == 5 ~ "George W. Bush",
                               pres_indicator == 6 ~ "Barack Obama")
  )

## Tibble of USA votes
us_votes <- cart|> 
  filter(Country == "USA")|>
  select(rcid, vote)|>
  mutate(us_vote = vote)|>
  select(!vote)

View(us_votes)

##Merge with all other votes, to indicate US vote in each row
cart <- cart |>
  left_join(us_votes, by = join_by(rcid))


## Adding Indicator of Voting With US or Not 
cart <- cart|> 
  mutate(coin_us = case_when((vote == 1 & us_vote == 1) | (vote ==3 & us_vote ==3) ~"Both Affirm/Deny",
                              vote %in% c("2","8") & us_vote %in% c("2","8") ~"Both Abstain/Absent",
                              (vote == 1 & us_vote ==2) | (vote == 2 & us_vote == 1) ~"Contra",
                             vote %in% c("2", "8") & us_vote %in% c("1", "2") ~ "Mixed"))

## Assigning Weights 
cart <- cart|> 
  mutate(weight_coin_us = case_when((vote == 1 & us_vote == 1) | (vote ==3 & us_vote ==3) ~ 1,
                              vote %in% c("2","8") & us_vote %in% c("2","8") ~ .5,
                              (vote == 1 & us_vote ==2) | (vote == 2 & us_vote == 1) ~0,
                             vote %in% c("2", "8") & us_vote %in% c("1", "2") ~ .5))

View(cart)


## Getting ATE per Country 
per_country_party <- cart|> 
  group_by(Country, party)|> 
  summarize(mean_country_coin = mean(weight_coin_us, na.rm = TRUE))|>
  pivot_wider(names_from = party,
              values_from = mean_country_coin)|>
  mutate( ate = `Democrat` - `Republican`)
  
View(per_country_party)





```






```{r}

## Top 10 receivers of aid 
top10_rec<- ideal_aid|> group_by(country)|>
  summarize(total_aid = sum(commitment_amount_usd_constant_sum))|>
  top_n(10, total_aid)|> 
  pull(country)

## Plotting top 10 recievers of aid 
ideal_aid|>
  filter(country %in% top10_rec)|>
  ggplot(mapping = aes(x = year, y = distance))+
    geom_line(mapping = aes(color = country))

##Distributions of distances, all  through time
ideal_aid|>
  ggplot(mapping = aes(x = distance_abs))+
  geom_histogram()

##What causes a big drop in the data? Are there any changes that are bigger than others? 
ideal_aid |> group_by(ccode, session)|>
  summarize(mean_prev_years = sum(idealpin ))
  mutate(change_diff =  )


                    
ideal_aid<- ideal_aid |> 
  select(!session_minus_one)



## W/O USA
ideal_wo_us <- ideal|> 
  group_by(country_cown, year_match)|>
  select(ccode, session, IdealPointAll, Countryname, year_match, country_cown, country_cowc)|>
  filter(!country_cown == 2)

## US Values only
ideal_onlyus <- ideal|>
  filter(country_cown == 2)|>
  select(session, IdealPointAll)|>
  mutate(idealpoint_us = IdealPointAll)|>
  select(!IdealPointAll)

## ideal now has US value
ideal<- ideal|> 
  left_join(ideal_onlyus, by = join_by(session))

ideal <- ideal|> 
  mutate(distance = idealpoint_us - IdealPointAll)|>
  mutate(distance_abs = abs(distance))

View(ideal_us)




```



```{r}

##Using USD for some reggresions 
ideal_aid|>
  ggplot(mapping = aes(x =  committed_millions,
                       y = distance_abs))+
  geom_point()

fit <- lm(distance_abs ~ committed_millions, data = ideal_aid)

summary(fit)

View(fit)
coef(fit)


##Using USD
ideal_treat|> 
  ggplot(mapping = aes(x = committed_millions,
                       y = change_one_before))+
  geom_point()

fit_usd_one <-  lm(change_one_before ~ committed_millions, data = ideal_treat)
fit_usd_two <-  lm(change_two_before ~ committed_millions, data = ideal_treat)

```




```{r loadata, echo = FALSE}
library(tidyverse)
library(dplyr)
install.packages("lubridate")
install.packages("countrycode")
library(lubridate)
library(countrycode)

load("~/Desktop/GOV 50/Projects/Final/final_project/data/un_votes.RData") ## 

ideal <-  read.csv("data/IdealpointestimatesAll_Jul2023.csv")
lead <- read_dta("data/WhyLeadersFightLEADDataset_updated.dta")
presidents <- read.csv("data/presidents.csv")

presidents <- presidents|>
  select(Presidency, President, Took.office, Left.office, Party)

View(ideal)
View(completeVotes)
View(presidents)
## Create the presidents tibble for dates. 

completeVotes|> summary()

```










```{r editingideal}
### Adding new colums for other years
ideal_aid <- ideal_aid|> left_join(minus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_minus_one"))

ideal_aid <- ideal_aid|> left_join(minus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_minus_two"))

ideal_aid <- ideal_aid|> left_join(plus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_one"))


ideal_aid <- ideal_aid|> left_join(plus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_two"))

## Ordering and new titles for columns 
ideal_aid<- ideal_aid|> 
  mutate(distance_two_before = distance_abs_plus_two,
         distance_one_before = distance_abs_plus_one,
         distance_duplicate = distance_abs,
         distance_one_after = distance_abs_minus_one,
         distance_two_after = distance_abs_minus_two)

## Mutating for difference 
ideal_aid<- ideal_aid|> 
  mutate(change_one_before = distance_one_before - distance_duplicate,
         change_two_before = distance_two_before - distance_duplicate)
```


```{r fromresults}
fit_treat<- lm(change_one_before ~ treatment_any, data = ideal_treat)
summary(fit_treat)

## Making distribution of the differences for all sessions 
ate_table|> ggplot( mapping = aes(x = `0`))+
  geom_histogram()

ate_table|> ggplot( mapping = aes(x = `1`))+
  geom_histogram()

## Making point chart for means of sessions
ate_table|> ggplot(mapping = aes( x = ))



##Calculating Means of all sessions 
ate_averages_across <- c(mean(ate_table_names$Treatment), mean(ate_table_names$Control))
as_tibble(ate_averages_across)|> 

ate_averages_across<- data.frame(Treatment = mean(ate_table_names$Treatment),
                                 Control = mean(ate_table_names$Control)
                                 )
  
ate_average_across_table<- as_tibble(ate_averages_across)|> 
  mutate(ate_across_sessions =  `Treatment` - `Control`)

colnames(ate_average_across_table)<- c("Treatment Mean Sessions", "Control Mean Across Sessions", "ATE Across Sessions")

```


```{r}


ideal_treat<- ideal_aid|> mutate(treatment_any =  if_else(committed_millions > 0, 1, 0),
                                 treat_some = if_else( (committed_millions > 0) & (committed_millions <= 1), 1, 0),
                                 treat_middle = if_else( (committed_millions > 1) & (committed_millions <= 100),1,0),
                                 treat_high = if_else(committed_millions >100, 1, 0),
                                 treat_sig = if_else(committed_millions > 10, 1, 0)
                                )

## Histogram of Changes
 ideal_aid|> 
  ggplot(mapping = aes(x = change_one_before))+
  geom_histogram()

 ideal_aid|> 
  ggplot(mapping = aes(x = change_two_before))+
  geom_histogram()
 






```




```{r}
 

minus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session - 1)

minus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session - 2)
 
plus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session + 1 )

plus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session + 2)

### Adding new colums for other years
ideal_dis <- ideal_aid|> left_join(minus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_minus_one"))

ideal_aid <- ideal_aid|> left_join(minus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_minus_two"))

ideal_aid <- ideal_aid|> left_join(plus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_one"))


ideal_aid <- ideal_aid|> left_join(plus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_two"))

## Ordering and new titles for columns 
ideal_aid<- ideal_aid|> 
  mutate(distance_two_before = distance_abs_plus_two,
         distance_one_before = distance_abs_plus_one,
         distance_duplicate = distance_abs,
         distance_one_after = distance_abs_minus_one,
         distance_two_after = distance_abs_minus_two)

## Mutating for difference 
ideal_aid<- ideal_aid|> 
  mutate(change_one_before = distance_one_before - distance_duplicate,
         change_two_before = distance_two_before - distance_duplicate)


```



## Finding prev years into rows
minus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session - 1)

minus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session - 2)
 
plus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session + 1 )

plus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session + 2)


```{r}

##Simple Population Means
ideal_treat|> group_by(treatment_any)|> 
  summarize(total_change = mean(change_one_before, na.rm = TRUE))

## Getting just country data for one session, example.
ideal_treat|> 
  filter(session == 29)|>
  select(session, Countryname, committed_millions, treatment_any, IdealPointAll, idealpoint_us, distance_abs, change_one_before)

## Treatment Means and ATE per session, for any aid
test<- ideal_treat|> group_by(session, treatment_any)|>
  summarize(mean_change_one = mean(change_one_before, na.rm = TRUE))|>
  pivot_wider(names_from = treatment_any,
              values_from = mean_change_one)|>
  mutate(session_ate = `1` - `0`)|>
  filter(!is.na(session_ate))

 ## Mean across sessions, any aid 
mean(test$session_ate)

##Regression with treatment, any aid 
fit_treat<- lm(change_one_before ~ treatment_any, data = ideal_treat)
summary(fit_treat)$ coefficients








## Simple means for sig aid
ideal_treat|> group_by(treat_sig)|> 
  summarize(total_change = mean(change_one_before, na.rm = TRUE))

## Treatment Means and ATE per session for significant aid
test_2<- ideal_treat|> group_by(session, treat_sig)|>
  summarize(mean_change_one = mean(change_one_before, na.rm = TRUE))|>
  pivot_wider(names_from = treat_sig,
              values_from = mean_change_one)|>
  mutate(session_ate = `1` - `0`)|>
  filter(!is.na(session_ate))

## Mean across sessions, sig aid
mean(test_2$session_ate)
```

```{r dataglance, eval = FALSE}

## Familiarizing Data.
aid_us|> ggplot(mapping = aes( x = year, y = commitment_amount_usd_constant_sum ))+
  geom_point()

country_amount <-aid_us |> 
   group_by(year_match)|> 
   summarize(num_countries  = length(unique(country_cown)),
             total_given = sum(commitment_amount_usd_constant_sum)) 
  
aid_us |>
  ggplot(mapping = aes(x = as.factor(year_match),
                               y = commitment_amount_usd_constant_sum) )+
  geom_boxplot()+
  scale_y_log10()

country_amount|>
  ggplot(mapping = aes(x = as.factor(year_match),
                       y = num_countries))+
  geom_line()


country_amount|>
  ggplot(mapping = aes(x = year_match,
                       y = total_given))+
  geom_line()
```

### Further Analysis 
```{r}
## Density Chart for ATE Table
ate_table_longer|> 
  mutate(treatment = as.factor(treatment))|>
  ggplot( mapping = aes(x = change_one_before,
                        fill = treatment,
                        color =  treatment))+
  geom_density(alpha = 0.3)


##Distribution Charts for ATE Table 
ate_table_longer|> 
  mutate(treatment = as.factor(treatment))|>
  ggplot( mapping = aes(x = change_one_before,
                        fill = treatment,
                        color =  treatment))+
  geom_histogram()



##Whisker Charts
ggplot(data = midwest,
       mapping = aes(x = percbelowpoverty,
                     fill = state, color = state)) +
  geom_density(alpha = 0.3)

```
