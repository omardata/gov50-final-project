---
title: "Gov 50 Final Project"
author: "Omar Cano"
description: "My final project"
output:
  distill::distill_article:
    self_contained: false
---

```{r}
library(tidyverse)
library(tidyverse)
library(dplyr)
install.packages("lubridate")
install.packages("countrycode")
library(lubridate)
library(countrycode)

load("~/Desktop/GOV 50/Projects/Final/final_project/data/un_votes.RData") ## 

ideal <-  read.csv("data/IdealpointestimatesAll_Jul2023.csv")
lead <- read_dta("data/WhyLeadersFightLEADDataset_updated.dta")
presidents <- read.csv("data/presidents.csv")

presidents <- presidents|>
  select(Presidency, President, Took.office, Left.office, Party)

View(ideal)
View(completeVotes)
View(presidents)
## Create the presidents tibble for dates. 

completeVotes|> summary()

```

## 1 Introduction: introduce the research question and hypothesis and briefly describe why it is interesting (1-2 paragraphs)
This paper will explore the relationship between a country's foreign-policy preferences and the amount of aid that country receives from the United States. Ultimately the question that interets me is does US provision of aid make the recipients of aid more inclined to the support of the US-led liberal world order? 

There has been some evidence for US practice of using the IMF and World Bank to buy support from other member states for its position on votes in the United Nations General Council (reference Dreher and Strun 2012). However interesting  this sort of analysis is, my paper aims to do something a bit different than a focus on vote buying. Some like  Dreher, Axel, P. Nunnenkamp, and R. Thiele. 2008 (‘‘Does US Aid Buy UN General Assembly Votes? A Disaggregated Analysis.’’ Public Choice 136 (1): 139-64.)) explore the question of how aid might be a means of buying support for votes. While they give a robust treatement of the quesiton regarding the effects of different types of aid, they are still interested in simply in the voting coincidence of the US and a recipient of its aid. 

My approach is a bit different, and focuses not on the effect of aid on voting coincidence, but on state-preference. My  research question is this: Do the state preferences of countries that receive US aid become more aligned with those of the US? My central hypothesis is that when the US gives a country aid, it becomes more likely that the state preferences between these two countries align. A second hypothesis that I am interested in testing is whether or not the  recipients of greater levels of US aid are more likely to vote in-line with the US than recipients of lower amounts of US aid. The null hypothesis is that there any difference between the measure of US-voting coincidence and the amount of aid that a country receives is due to random chance.

Evidence for an increase in alignment  would be to see a decrease in the distance. Thus evidence for my hypothesis would be to see that following the commitment of aid this distance would decrease, that is we would see a negative change over one year.  

## 2 Data Section ---------- Briefly describes the data source, describes how the key dependent and independent variables are measured (e.g., a survey, statistical model, or expert coding), and also produces a plot that summarizes the dependent variable) (2-3 paragraphs)

In order to analyze this effect I use two pretty cool data sets, one for the dependent variable and one for the independent variable.

My dependent variable, ` ____ `, is calculated from estimated measures of state preference provided by Dreher et. all 2008. This numeric estimate of state preference that Dreher et al provide is the result of a statistical model  that uses, in part, Eric Voeten's data on member-state votes in the United Nations General Assembly. This numeric measure of state-preference is given at a state/session level, that is it provides a single measure of state preference for a given country, in a given year. This ideal point data is more than just measure of state voting coincidence with the US-- this data set is one of the things that makes this paper interesting. This ideal point estimate is ___ and ___ and ____. Ultimately, their ideal sestimate is a measure of "consistently capture the position of states vis-a`-vis a US-led liberal order."(pg 431). Dreher et al explicitly state the suitability of their ideal point estimates for analyzing the influence of aid, thus this is an interesting project that is taking this cool data from a statistical model and using it to attempt to learn about the dynmaic that unfolds with US aid. 

There are a two steps to calculating my dependent variable `change_distance_one`. First, I had to calculate a measure of the alignment of state preference between a given country and the US for a given session.  The variable `distance_abs` is a measure of the alignment of a given country  with the US in a given session, arrived at by subtracting the value of the a given countries ideal-point estimate for a particular session from the USA's ideal-point estimate for that same session, and finally taking the absolute value. Second, I use this `distance_abs` variable to calculate a measure of how a  countries preference alignment with the US has changed from the past session to the current session. Thus, my dependent variable `change_distance_one`, for a given country in session n is calculated by subtracting the `distance_abs`of session n from the `distance_abs` value for that country in session n-1. 

Data for my independent variable, `aid_commitment`, comes from  AidData’s Core Research Release Version 3.0. The data set provides aggregated data (but also, they provide disaggreated data that is coded much more detail) on the amount of bilateral aid that a country reports that they committed to giving another country. This includes aid that was reported in __ and is given in constant dollars ($USD for 2011) to allow for time-series analysis. This variable is also reported at a recipient-year level, meaning that it provides the amount that the United State's committed to a given state in a given year. I follow the practice of assuming that if a country didn't report aid to report that as a zero, and to take a commitment to providing aid as a sufficient variable for anlaysis though there might be some discrepancy for aid that actually is paid out and aid that is committed.  

If we look at all the observed changes in distance_abs for all sessions, they appear to be normally distributed and centered at about zero, with a standard deviation of `r change_one_sd`. 

```{r}
changes_dist <- ideal_treat|> 
  ggplot(mapping = aes( x = change_one_before))+
  geom_histogram()

change_one_sd <- sd(ideal_treat$change_one_before, na.rm = TRUE)

summary(ideal_treat$change_one_before)

  
```

My research design employs a differences-in-differences approach. I treat the the reception of aid as the treatment condition and want to investigate its effect on the alignment of state preferences. So  no aid commitment in is the control, and receiving aid is the treatment. More specifically I lag the aid commitment to make it so that for a given session n, a  country is counted as being in the control group if and only if it received a commitment for aid in the the year before that session. Lagging the time of the of the commitment by one year is to preempt possible ___. 


For a given country in session n we can calculate the difference in how that alignment with the United States has changed from the previous session, n-1. This gives us a value for the variable `change_one_before`, which is the before and after difference for a given country. To calculate the difference in differences we can then first take the average change among all countries in the control group and subtract it from the average change of all countries in the treatment group. This gives us an estimated average treatment effect. 

I work under the assumption that in a given session all countries will experience, on average parallel trends through time. Thus, if we observe a decrease in the distance from the USA for countries that are in the treatment group that is relatively higher than the decrease that we observe for those in the treament, this would be evidence for my hypothesis. That is a statistically significant negative ATE would be evidence for my hypothesis. 

## Results--------- plot of main analysis + regression output + 2-3 paragraphs of description and interpretation of the plots and regression (including interpreting the main coefficient of interest and describing if it is statistically significant and if we should interpret it causally). This section could be longer if you choose to include additional analyses. (8pts)

In summary my findings are that on average the commitment of bilateral aid from the US to other countries is correlated with a foreign-policy preference convergence between the US and those countries. REWORD.
```{r}
ideal_treat|> 
  ggplot(mapping = aes(x = committed_millions,
                       y = change_one_before))+
  geom_point()

fit_usd_one <-  lm(change_one_before ~ committed_millions, data = ideal_treat)
fit_usd_two <-  lm(change_two_before ~ committed_millions, data = ideal_treat)




```



Interpretation of Coeficients 
Stastical Significance?  

## Conclusion






```{r loadata, echo = FALSE}
library(tidyverse)
library(dplyr)
install.packages("lubridate")
install.packages("countrycode")
library(lubridate)
library(countrycode)

load("~/Desktop/GOV 50/Projects/Final/final_project/data/un_votes.RData") ## 

ideal <-  read.csv("data/IdealpointestimatesAll_Jul2023.csv")
lead <- read_dta("data/WhyLeadersFightLEADDataset_updated.dta")
presidents <- read.csv("data/presidents.csv")

presidents <- presidents|>
  select(Presidency, President, Took.office, Left.office, Party)

View(ideal)
View(completeVotes)
View(presidents)
## Create the presidents tibble for dates. 

completeVotes|> summary()

```

## Ideal Points  
```{r}
## Can use a countries ideal point estimate? 
## Can use a fraction of the voting decisions? Maybe use the ideal points first, if time think about the raw voting data
View(ideal)

## Adding year from session 
ideal <- ideal|> mutate( country_cowc = countrycode(ccode, origin = 'cown' , destination = 'cowc'),
                         country_cown = ccode,
                         year_match = session + 1945)
## W/O USA
ideal_wo_us <- ideal|> 
  group_by(country_cown, year_match)|>
  select(ccode, session, IdealPointAll, Countryname, year_match, country_cown, country_cowc)|>
  filter(!country_cown == 2)

## US Values only
ideal_onlyus <- ideal|>
  filter(country_cown == 2)|>
  select(session, IdealPointAll)|>
  mutate(idealpoint_us = IdealPointAll)|>
  select(!IdealPointAll)

## ideal now has US value
ideal<- ideal|> 
  left_join(ideal_onlyus, by = join_by(session))

ideal <- ideal|> 
  mutate(distance = idealpoint_us - IdealPointAll)|>
  mutate(distance_abs = abs(distance))

View(ideal)



## Familiarizing Self w data
ideal|> ggplot(mapping = aes(x = distance_abs))+
  geom_histogram()

ideal|> ggplot(mapping = aes(x = distance))+
  geom_histogram()

```


###Prepping Aid Data 
```{r}
## This is the aggregated data, can choose to use thes disaggregated later, if time 
aid <- read.csv("data/AidDataCoreDonorRecipientYear_ResearchRelease_Level1_v3.0.csv")
aid
## Got correct number of row? Yes. 

View(aid_us)

##gives data from 1973 to 2013 
aid_us <- aid|>
  filter(donor == "United States")

##Change from  recepient name to COW character country code, add COW numeric code for matching w Ideal point data
aid_us <- aid_us|> mutate( country = countrycode(recipient, origin = 'country.name', destination = 'cowc'))
aid_us <- aid_us|> mutate( country_cown = countrycode(country, origin = 'cowc', destination = 'cown'))

aid_us_test <- aid_us |> filter(is.na(country_cown))

## Testing Names, there are no names that are ambigously coded for COW C that show up in the UN voting data anyway, so there are no errors for COW N either 
unique(aid_us_test$recipient)
unique_names <- unique(cart$Countryname)
unique_names <- enframe(unique_names)
View(unique_names)
cart|> filter(Countryname == "Serbia")

## Aid US, changing date, PLUS on year. In order to use previous year's aid commitments to the vote year
aid_us <- aid_us |> mutate(year_match = year + 1)|> select(!year_lagged)

## Familiarizing Data.
aid_us|> ggplot(mapping = aes( x = year, y = commitment_amount_usd_constant_sum ))+
  geom_point()

country_amount <-aid_us |> 
   group_by(year_match)|> 
   summarize(num_countries  = length(unique(country_cown)),
             total_given = sum(commitment_amount_usd_constant_sum)) 
  


aid_us |>
  ggplot(mapping = aes(x = as.factor(year_match),
                               y = commitment_amount_usd_constant_sum) )+
  geom_boxplot()+
  scale_y_log10()
  
  
  
country_amount|>
  ggplot(mapping = aes(x = as.factor(year_match),
                       y = num_countries))+
  geom_line()


country_amount|>
  ggplot(mapping = aes(x = year_match,
                       y = total_given))+
  geom_line()

 
```

## Merging Aid and Idea 
```{r}

##Checking that UN is unique? Good. 
aid_us|>
  count(country_cown, year_match) |>
  filter(n > 1)

## Remove data for country_cown is N/A
aid_us <-  aid_us|>filter(!is.na(country_cown))

## Check that ideal point is unique? Good.
ideal|>
  count(country_cown, year_match) |>
  filter(n > 1)

##Joined Aid and Ideal
ideal_aid <- ideal|> 
  left_join(aid_us, join_by(country_cown, year_match))
View(ideal_aid)

## adding column for zeros instead of NAs
ideal_aid<- ideal_aid |>
  mutate(committed = if_else( is.na(commitment_amount_usd_constant_sum), 0, commitment_amount_usd_constant_sum ))
         
## Adding millions
ideal_aid<- ideal_aid |>
  mutate(committed_millions = committed/ 1000000)

View(ideal_aid)

## Adding group for aid determination.. is there some way of showing this? 


```


```{r}
minus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session - 1)

minus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session - 2)
 
plus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session + 1 )

plus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, distance_abs)|>
  mutate(session = session + 2)


```



## Finding prev years into rows
minus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session - 1)

minus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session - 2)
 
plus_one <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session + 1 )

plus_two <- ideal_aid|> 
  group_by(ccode, session)|>
  select(ccode, session, IdealPointAll)|>
  mutate(session = session + 2)

```{r}
### Adding new colums for other years
ideal_aid <- ideal_aid|> left_join(minus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_minus_one"))

ideal_aid <- ideal_aid|> left_join(minus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_minus_two"))

ideal_aid <- ideal_aid|> left_join(plus_one, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_one"))


ideal_aid <- ideal_aid|> left_join(plus_two, 
                      by = join_by(ccode, session),
                      suffix =  c("", "_plus_two"))

## Ordering and new titles for columns 
ideal_aid<- ideal_aid|> 
  mutate(distance_two_before = distance_abs_plus_two,
         distance_one_before = distance_abs_plus_one,
         distance_duplicate = distance_abs,
         distance_one_after = distance_abs_minus_one,
         distance_two_after = distance_abs_minus_two)

## Mutating for difference 
ideal_aid<- ideal_aid|> 
  mutate(change_one_before = distance_one_before - distance_duplicate,
         change_two_before = distance_two_before - distance_duplicate)

```

## Results

```{r}


ideal_treat<- ideal_aid|> mutate(treatment_any =  if_else(committed_millions > 0, 1, 0),
                                 treat_some = if_else( (committed_millions > 0) & (committed_millions <= 1), 1, 0),
                                 treat_middle = if_else( (committed_millions > 1) & (committed_millions <= 100),1,0),
                                 treat_high = if_else(committed_millions >100, 1, 0),
                                 treat_sig = if_else(committed_millions > 10, 1, 0)
                                )


## Histogram of Changes
 ideal_aid|> 
  ggplot(mapping = aes(x = change_one_before))+
  geom_histogram()

 ideal_aid|> 
  ggplot(mapping = aes(x = change_two_before))+
  geom_histogram()
 
## Changes Regressions with dollars
fit_diff_one <- lm(change_one_before ~ committed_millions, data = ideal_aid)
fit_diff_two<- lm(change_two_before ~ committed_millions, data = ideal_aid)

summary(fit_diff_one)
summary(fit_diff_two)

## Changes Regression with treatement
fit_treat<- lm(change_two_before ~ treatment_any, data = ideal_treat)
fit_treat_all <- lm (change_two_before ~ treatment_any + treat_some + treat_middle + treat_high, data = ideal_treat)

summary(fit_treat)
summary(fit_treat_all)

## Treatment Means and ATE per session, for any aid 
ideal_treat|> group_by(session, treatment_any)|>
  summarize(mean_change_one = mean(change_one_before, na.rm = TRUE))|>
  pivot_wider(names_from = treatment_any,
              values_from = mean_change_one)|>
  mutate(session_ate = `1` - `0`)


## Treatment Means and ATE per session for significant aid
ideal_treat|> group_by(session, treat_sig)|>
  summarize(mean_change_one = mean(change_one_before, na.rm = TRUE))|>
  pivot_wider(names_from = treat_sig,
              values_from = mean_change_one)|>
  mutate(session_ate = `1` - `0`)|>
  filter(!is.na(session_ate))


ideal_treat|> ggplot(mapping = aes( ))




```





## Doing this for distances not just ideal points... changes in ditances 






















## Scrap Writing
I want to explore the extent to which there is state agreement on certain votes? 
The effect of something on voting coincidence in a particular time period and in a particular topic? 

The effect of political turn-over in the UNGA voting coincidence?
The role of leaders?
The role of some country-level feature?
 
 
Do small states agree more, do large states disagree more?
Democratic or Republican presidents at the UN?
Are there any statistical differences?



Which subset of states? 
Which votes, how to measure voting coincidence. Mutate,and create new variable that states coindidence or no coindidence. There are 

Domestic Turn-over, or... international factors.. 

 
What are valid and easy paper topics?
I just need either an easy GOV 50 paper, or an easy overlap between the GOV 50 paper and the UN paper. 

Do work on the UN paper first. Maybe whether or not there is an overlap. 


Can also just do a single-time analysis. 
Need something to test about the countries. '

```{r}
##Counting Number of Votes Total by Party
cart |> group_by(party)|>
  summarize(total = length(unique(rcid)))

##Mean Coincidence by Party
cart|> group_by(party)|>
  summarize(mean_coin = mean(weight_coin_us, na.rm = TRUE))

##Mean Coincidence per President
cart|> group_by(president)|>
summarize(mean_coin = mean(weight_coin_us, na.rm = TRUE))

##Maybe remove the israel votes? Maybe look at 
##Maybe look at who votes in line with the US most often?

cart|> group_by(Country, party)|>
  summarize(mean_coin_country = mean(weight_coin_us, na.rm = TRUE))|>
  pivot_wider(names_from = party, 
              values_from = mean_coin_country)|>
  mutate(ate = `Democrat` - `Republican`)|>
  ggplot(mapping = aes( y = ate))+
  geom_histogram()
```

```{r}
# Testing trump 
votes_trump<- completeVotes|>
  filter(year >= 2017)|>
  group_by(rcid)|> 
  summarize(mean = mean(vote ==1) )

votes_trump

View(completeVotes)

unique(completeVotes$year)
votes_trump|> summarize(mean = mean(mean))


votes_obama <- completeVotes|>
  filter(year < 2017 & year>2008)|>
  group_by(rcid)|> 
  summarize(mean = mean(vote ==1) )
votes_obama|> summarize (mean = mean(mean))


  group_by(rcid)|>
  summarize(mean_yes = mean(vote == 1))|>
  ggplot( mapping = aes( x =mean_yes))+
  geom_histogram(binwidth = .05)

## From LEAD data
lead_trump<- lead |> filter(year >= 2019)
lead
unique(lead_post1975$idacr)

```



```{r}
## Editing Dates on President's to Match UNGA Votes Format 
presidents <- presidents |> 
  mutate(left_office = as.Date(Left.office, format = "%d/%m/%Y"),
         took_office = as.Date(Took.office, format = "%d/%m/%Y"))

## Vote data to correct date format
completeVotes2 <- completeVotes|> mutate(
  date = as.Date(date, format = "%Y-%m-%d"))

View(completeVotes2)

##Subset UN Data, want only carter to Obama Votes
carter_obama <- completeVotes2|>
  filter( date > "1977-01-20" & date < "2017-01-20") ## needed to use just greater or lesser than

View(carter_obama)

##creating vector of democrat presidents 
democratic_indiators <- c("1", "4", "6")

##Assigning Presidency, Rep or Dem, and also president identifier 1 for carter, 2 for Reagan etc 
cart <- carter_obama|>
    mutate(pres_indicator = case_when( (date > "1977-01-20" & date < "1981-01-20") ~ "1",
                                       (date > "1981-01-20" & date < "1989-01-20") ~ "2",
                                       (date > "1989-01-20" & date < "1993-01-20") ~ "3",
                                       (date > "1993-01-20" & date < "2001-01-20") ~ "4",
                                       (date > "2001-01-20" & date < "2009-01-20") ~ "5",
                                       (date > "2009-01-20" & date < "2017-01-20") ~ "6")
           )|>
  mutate(democrat = if_else(pres_indicator %in% democratic_indiators, "1", "0"))|>
  mutate(party = if_else(democrat == 1, "Democrat", "Republican"))|>
  mutate(president = case_when(pres_indicator == 1 ~ "Jimmy Carter",
                               pres_indicator == 2 ~ "Ronald Reagan",
                               pres_indicator == 3 ~ "George H. W. Bush",
                               pres_indicator == 4 ~ "Bill Clinton",
                               pres_indicator == 5 ~ "George W. Bush",
                               pres_indicator == 6 ~ "Barack Obama")
  )

## Tibble of USA votes
us_votes <- cart|> 
  filter(Country == "USA")|>
  select(rcid, vote)|>
  mutate(us_vote = vote)|>
  select(!vote)

View(us_votes)

##Merge with all other votes, to indicate US vote in each row
cart <- cart |>
  left_join(us_votes, by = join_by(rcid))


## Adding Indicator of Voting With US or Not 
cart <- cart|> 
  mutate(coin_us = case_when((vote == 1 & us_vote == 1) | (vote ==3 & us_vote ==3) ~"Both Affirm/Deny",
                              vote %in% c("2","8") & us_vote %in% c("2","8") ~"Both Abstain/Absent",
                              (vote == 1 & us_vote ==2) | (vote == 2 & us_vote == 1) ~"Contra",
                             vote %in% c("2", "8") & us_vote %in% c("1", "2") ~ "Mixed"))

## Assigning Weights 
cart <- cart|> 
  mutate(weight_coin_us = case_when((vote == 1 & us_vote == 1) | (vote ==3 & us_vote ==3) ~ 1,
                              vote %in% c("2","8") & us_vote %in% c("2","8") ~ .5,
                              (vote == 1 & us_vote ==2) | (vote == 2 & us_vote == 1) ~0,
                             vote %in% c("2", "8") & us_vote %in% c("1", "2") ~ .5))

View(cart)


## Getting ATE per Country 
per_country_party <- cart|> 
  group_by(Country, party)|> 
  summarize(mean_country_coin = mean(weight_coin_us, na.rm = TRUE))|>
  pivot_wider(names_from = party,
              values_from = mean_country_coin)|>
  mutate( ate = `Democrat` - `Republican`)
  
View(per_country_party)





```






```{r}

## Top 10 receivers of aid 
top10_rec<- ideal_aid|> group_by(country)|>
  summarize(total_aid = sum(commitment_amount_usd_constant_sum))|>
  top_n(10, total_aid)|> 
  pull(country)

## Plotting top 10 recievers of aid 
ideal_aid|>
  filter(country %in% top10_rec)|>
  ggplot(mapping = aes(x = year, y = distance))+
    geom_line(mapping = aes(color = country))

##Distributions of distances, all  through time
ideal_aid|>
  ggplot(mapping = aes(x = distance_abs))+
  geom_histogram()

##What causes a big drop in the data? Are there any changes that are bigger than others? 
ideal_aid |> group_by(ccode, session)|>
  summarize(mean_prev_years = sum(idealpin ))
  mutate(change_diff =  )


                    
ideal_aid<- ideal_aid |> 
  select(!session_minus_one)



## W/O USA
ideal_wo_us <- ideal|> 
  group_by(country_cown, year_match)|>
  select(ccode, session, IdealPointAll, Countryname, year_match, country_cown, country_cowc)|>
  filter(!country_cown == 2)

## US Values only
ideal_onlyus <- ideal|>
  filter(country_cown == 2)|>
  select(session, IdealPointAll)|>
  mutate(idealpoint_us = IdealPointAll)|>
  select(!IdealPointAll)

## ideal now has US value
ideal<- ideal|> 
  left_join(ideal_onlyus, by = join_by(session))

ideal <- ideal|> 
  mutate(distance = idealpoint_us - IdealPointAll)|>
  mutate(distance_abs = abs(distance))

View(ideal_us)


```



```{r}

##Using USD for some reggresions 
ideal_aid|>
  ggplot(mapping = aes(x =  committed_millions,
                       y = distance_abs))+
  geom_point()

fit <- lm(distance_abs ~ committed_millions, data = ideal_aid)

summary(fit)

View(fit)
coef(fit)

```

